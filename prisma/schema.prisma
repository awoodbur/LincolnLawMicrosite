// Prisma schema for Lincoln Law intake leads
// SQLite (dev) / PostgreSQL (prod) compatible

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Lead Model - Core intake data
model Lead {
  id                String    @id @default(cuid())

  // Contact
  email             String
  phone             String?

  // Location
  state             String    // Should always be "Utah" for now
  county            String?

  // Household
  householdSize     Int       // 1-7, or 8 for "8+"
  maritalStatus     String    // "Single", "Married", "Separated", "Divorced"

  // Employment & History
  employmentStatus  String    // "Employed", "Self-employed", "Unemployed", "Retired"
  priorBankruptcy   Boolean   @default(false)

  // Financial Details
  isAboveMedian     Boolean   @default(false) // Is income above Utah median for household size?
  monthlyExpenses   Float     @default(0)     // Necessary living expenses
  totalDebt         String    @default("<$10k") // Range: "<10000", "10000-25000", "25000-50000", ">50000"

  // Assets
  homeEquity        Float?    // null if doesn't own home
  vehicleEquity     Float     @default(0)
  hasValuableItems  Boolean   @default(false)

  // Urgency Flags
  missedPayments    Boolean   @default(false)
  wageGarnishment   Boolean   @default(false)
  propertyConcerns  Boolean   @default(false)

  // Additional
  notes             String?

  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  consentLogs       ConsentLog[]
  eligibilityResult EligibilityResult?
  auditLogs         AuditLog[]

  @@index([email])
  @@index([createdAt])
}

// Eligibility Assessment Results
model EligibilityResult {
  id                String   @id @default(cuid())
  leadId            String   @unique
  lead              Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  summary           String   @default("Pending evaluation") // "Chapter 7 Likely", "Chapter 13 Recommended", etc.
  recommendedChapter String  @default("7") // "7" or "13"
  chapter7Eligible  Boolean @default(true)

  // Test Results
  incomeTestPass    Boolean @default(true)
  budgetTestPass    Boolean @default(true)
  assetRisk         Boolean @default(false)

  reasons           String[] @default([]) // Array of key reasons
  disclaimer        String   @default("This is a preliminary assessment only.")

  createdAt         DateTime @default(now())

  @@index([leadId])
}

// Consent Tracking
model ConsentLog {
  id              String   @id @default(cuid())
  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  consentType     String   @default("all") // "privacy_policy", "terms_of_service", "consent_disclosure", "all"
  consentVersion  String   @default("v1.0") // Version number of the document
  ipAddress       String?
  userAgent       String?
  timestamp       DateTime @default(now())

  @@index([leadId])
}

// Audit Log for compliance
model AuditLog {
  id          String   @id @default(cuid())
  leadId      String?
  lead        Lead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)

  event       String   // "lead_created", "email_sent", etc.
  details     Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())

  @@index([leadId])
  @@index([timestamp])
}
