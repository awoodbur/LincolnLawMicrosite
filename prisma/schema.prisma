// Prisma schema for Lincoln Law intake leads
// SQLite (dev) / PostgreSQL (prod) compatible

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Lead {
  id                 String   @id @default(cuid())
  state              String   @default("Utah")
  county             String?
  householdSize      Int
  maritalStatus      String
  monthlyIncomeRange String
  unsecuredDebtRange String
  employmentStatus   String
  missedPayments     Boolean
  wageGarnishment    Boolean
  propertyConcerns   Boolean
  notes              String?
  email              String   @unique
  consentPrivacy     Boolean
  consentTerms       Boolean
  consentData        Boolean
  source             String   @default("lincolnlaw-utah-intake")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Optional relations for later extensions
  plaidSummary       PlaidSummary?
  eligibilityResult  EligibilityResult?
  consentLogs        ConsentLog[]
  auditLogs          AuditLog[]

  @@index([email])
  @@index([createdAt])
}

model PlaidSummary {
  id            String   @id @default(cuid())
  leadId        String   @unique
  lead          Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  transactions  String?  // JSON string
  identity      String?  // JSON string
  summaryJson   String?  // JSON string
  createdAt     DateTime @default(now())
}

model EligibilityResult {
  id             String   @id @default(cuid())
  leadId         String   @unique
  lead           Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  tier           String
  rationale      String   // JSON string
  metrics        String   // JSON string
  disclaimers    String   // JSON string
  createdAt      DateTime @default(now())
}

model ConsentLog {
  id          String   @id @default(cuid())
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  version     String   @default("v1.0")
  acceptedAt  DateTime @default(now())
  ip          String?
  userAgent   String?

  @@index([leadId])
}

model AuditLog {
  id          String   @id @default(cuid())
  leadId      String?
  lead        Lead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)
  actor       String   // "system", "user", "admin"
  event       String   // "lead_created", "consent_accepted", "plaid_linked", etc.
  payloadJson String?  // Redacted summary, never includes PII/tokens
  createdAt   DateTime @default(now())

  @@index([leadId])
  @@index([event])
  @@index([createdAt])
}
